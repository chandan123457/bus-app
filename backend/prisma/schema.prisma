generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String         @id @default(uuid())
  name                String
  email               String         @unique
  password            String
  role                Role           @default(USER)
  createdAt           DateTime       @default(now())
  verified            Boolean        @default(false)
  phone               String?
  adminVerificationAt DateTime?
  adminVerified       Boolean        @default(false)
  busServiceName      String         @default("Ankush Travels")
  groups              BookingGroup[]
  ownedBuses          Bus[]
  notifications       Notification[]
  payments            Payment[]
}

model EmailVerification {
  id        Int      @id @default(autoincrement())
  email     String
  otp       String
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model PasswordReset {
  id        Int      @id @default(autoincrement())
  email     String
  otp       String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
}

model SuperAdmin {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String
  createdAt DateTime @default(now())
}

model Bus {
  id          String        @id @default(uuid())
  adminId     String
  busNumber   String        @unique
  name        String
  type        BusType
  layoutType  LayoutType
  totalSeats  Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  gridColumns Int           @default(4)
  gridRows    Int           @default(15)
  admin       User          @relation(fields: [adminId], references: [id], onDelete: Cascade)
  amenities   BusAmenities?
  images      BusImage[]
  holidays    Holiday[]
  seats       Seat[]
  stops       Stop[]
  trips       Trip[]

  @@index([adminId])
  @@index([busNumber])
}

model Stop {
  id                  String         @id @default(uuid())
  busId               String
  name                String
  city                String
  state               String?
  stopIndex           Int
  arrivalTime         String?
  departureTime       String?
  distanceFromOrigin  Float          @default(0)
  priceFromOrigin     Float          @default(0)
  lowerSeaterPrice    Float          @default(0)
  lowerSleeperPrice   Float          @default(0)
  upperSleeperPrice   Float          @default(0)
  returnArrivalTime   String?
  returnDepartureTime String?
  groupsFrom          BookingGroup[] @relation("GroupFromStop")
  groupsTo            BookingGroup[] @relation("GroupToStop")
  bus                 Bus            @relation(fields: [busId], references: [id], onDelete: Cascade)
  boardingPoints      StopPoint[]

  @@unique([busId, stopIndex])
  @@index([busId, stopIndex])
  @@index([city])
  @@index([name])
}

model StopPoint {
  id             String         @id @default(uuid())
  stopId         String
  type           StopPointType  @default(BOARDING)
  name           String
  landmark       String?
  address        String?
  time           String
  pointOrder     Int            @default(0)
  createdAt      DateTime       @default(now())
  boardingGroups BookingGroup[] @relation("GroupBoardingPoint")
  droppingGroups BookingGroup[] @relation("GroupDroppingPoint")
  stop           Stop           @relation(fields: [stopId], references: [id], onDelete: Cascade)

  @@index([stopId, type, pointOrder])
}

model Seat {
  id         String    @id @default(uuid())
  busId      String
  seatNumber String
  row        Int
  column     Int
  type       SeatType
  level      SeatLevel
  isActive   Boolean   @default(true)
  columnSpan Int       @default(1)
  rowSpan    Int       @default(1)
  bookings   Booking[]
  bus        Bus       @relation(fields: [busId], references: [id], onDelete: Cascade)

  @@unique([busId, seatNumber, level])
  @@index([busId])
  @@index([busId, type])
  @@index([busId, level])
}

model Trip {
  id            String         @id @default(uuid())
  busId         String
  tripDate      DateTime       @db.Date
  status        TripStatus     @default(SCHEDULED)
  createdAt     DateTime       @default(now())
  bookings      Booking[]
  bookingGroups BookingGroup[]
  bus           Bus            @relation(fields: [busId], references: [id], onDelete: Cascade)

  @@unique([busId, tripDate])
  @@index([busId, tripDate])
  @@index([tripDate, status])
}

model BookingGroup {
  id              String      @id @default(uuid())
  userId          String
  tripId          String
  fromStopId      String
  toStopId        String
  totalPrice      Float
  status          GroupStatus @default(PENDING)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  discountAmount  Float       @default(0)
  finalPrice      Float?
  offerId         String?
  boardingPointId String?
  droppingPointId String?
  bookings        Booking[]
  boardingPoint   StopPoint?  @relation("GroupBoardingPoint", fields: [boardingPointId], references: [id])
  droppingPoint   StopPoint?  @relation("GroupDroppingPoint", fields: [droppingPointId], references: [id])
  fromStop        Stop        @relation("GroupFromStop", fields: [fromStopId], references: [id])
  offer           Offer?      @relation(fields: [offerId], references: [id])
  toStop          Stop        @relation("GroupToStop", fields: [toStopId], references: [id])
  trip            Trip        @relation(fields: [tripId], references: [id])
  user            User        @relation(fields: [userId], references: [id])
  payment         Payment?

  @@index([userId])
  @@index([tripId])
  @@index([status])
}

model Booking {
  id          String        @id @default(uuid())
  groupId     String
  tripId      String
  seatId      String
  status      BookingStatus @default(CONFIRMED)
  cancelledAt DateTime?
  createdAt   DateTime      @default(now())
  group       BookingGroup  @relation(fields: [groupId], references: [id], onDelete: Cascade)
  seat        Seat          @relation(fields: [seatId], references: [id])
  trip        Trip          @relation(fields: [tripId], references: [id])
  passenger   Passenger?

  @@index([tripId, status])
  @@index([groupId])
}

model Passenger {
  id        String   @id @default(uuid())
  bookingId String   @unique
  name      String
  age       Int
  gender    Gender
  phone     String?
  email     String?
  createdAt DateTime @default(now())
  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
}

model BusAmenities {
  id             String   @id @default(uuid())
  busId          String   @unique
  hasWifi        Boolean  @default(false)
  hasCharging    Boolean  @default(false)
  hasAC          Boolean  @default(true)
  hasRestroom    Boolean  @default(false)
  hasBlanket     Boolean  @default(false)
  hasWaterBottle Boolean  @default(false)
  hasSnacks      Boolean  @default(false)
  hasTV          Boolean  @default(false)
  description    String?
  updatedAt      DateTime @updatedAt
  bus            Bus      @relation(fields: [busId], references: [id], onDelete: Cascade)
}

model Offer {
  id               String           @id @default(uuid())
  code             String           @unique
  description      String
  discountType     DiscountType
  discountValue    Float
  minBookingAmount Float?
  maxDiscount      Float?
  validFrom        DateTime
  validUntil       DateTime
  usageLimit       Int?
  usageCount       Int              @default(0)
  isActive         Boolean          @default(true)
  applicableBuses  String[]
  createdBy        String
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  creatorRole      OfferCreatorRole @default(ADMIN)
  bookingGroups    BookingGroup[]

  @@index([code])
  @@index([isActive, validFrom, validUntil])
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  isRead    Boolean          @default(false)
  metadata  Json?
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
}

model Holiday {
  id        String   @id @default(uuid())
  busId     String
  date      DateTime @db.Date
  reason    String?
  createdBy String
  createdAt DateTime @default(now())
  bus       Bus      @relation(fields: [busId], references: [id], onDelete: Cascade)

  @@unique([busId, date])
  @@index([busId, date])
  @@index([date])
}

model BusImage {
  id         String   @id @default(uuid())
  busId      String
  imageUrl   String
  publicId   String
  uploadedBy String
  createdAt  DateTime @default(now())
  bus        Bus      @relation(fields: [busId], references: [id], onDelete: Cascade)

  @@index([busId])
}

model Payment {
  id               String        @id @default(uuid())
  bookingGroupId   String?       @unique
  userId           String
  method           PaymentMethod
  baseAmount       Float
  baseCurrency     CurrencyCode  @default(NPR)
  chargedAmount    Float
  chargedCurrency  CurrencyCode
  exchangeRate     Float?
  gatewayOrderId   String?
  gatewayPaymentId String?
  gatewaySignature String?
  metadata         Json?
  status           PaymentStatus @default(INITIATED)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  bookingGroup     BookingGroup? @relation(fields: [bookingGroupId], references: [id], onDelete: Cascade)
  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([method, status])
}

enum Role {
  USER
  ADMIN
  SUPERADMIN
}

enum BusType {
  SEATER
  SLEEPER
  MIXED
}

enum LayoutType {
  TWO_TWO
  THREE_TWO
  FOUR_TWO
}

enum StopPointType {
  BOARDING
  DROPPING
}

enum SeatType {
  SEATER
  SLEEPER
}

enum SeatLevel {
  UPPER
  LOWER
}

enum TripStatus {
  SCHEDULED
  ONGOING
  COMPLETED
  CANCELLED
}

enum GroupStatus {
  PENDING
  CONFIRMED
  CANCELLED
  REFUNDED
}

enum BookingStatus {
  CONFIRMED
  CANCELLED
}

enum PaymentMethod {
  RAZORPAY
  ESEWA
}

enum PaymentStatus {
  INITIATED
  SUCCESS
  FAILED
  REFUNDED
}

enum CurrencyCode {
  NPR
  INR
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum OfferCreatorRole {
  ADMIN
  SUPERADMIN
}

enum NotificationType {
  BOOKING_CONFIRMED
  BOOKING_CANCELLED
  TRIP_CANCELLED
  OFFER_APPLIED
  TRIP_REMINDER
  GENERAL
}
